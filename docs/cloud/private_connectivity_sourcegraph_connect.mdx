# Private Resources in On-Prem Data Centers via Sourcegraph Connect Agent

<Callout type="note">This feature is in the Experimental stage. [Contact us](https://about.sourcegraph.com/contact) for more information.</Callout>

As part of the [Enterprise tier](https://sourcegraph.com/pricing), Sourcegraph Cloud supports connecting to resources in the customer's private network by deploying the Sourcegraph Connect tunnel agent in the customer's network.

## How it works

Sourcegraph Connect consists of three components:

Tunnel server: a centralized broker between clients and agents, managed by Sourcegraph. It authenticates agents and clients, enforces ACLs, sets up mTLS, and proxies encrypted traffic between clients and agents. Sourcegraph deploys each customer's tunnel server into its own dedicated GCP project.

Tunnel agent: deployed inside the customer's network, has its own identity, proxies and encrypts traffic between the code host and tunnel client. The agent can only communicate with permitted private resources inside the customer's network. The customer starts the tunnel agent with the credentials provided by Sourcegraph, then the agent authenticates and establishes a secure connection with the tunnel server. Only agents are allowed to establish secure connections with the tunnel server, and the server only accepts a connection if the agent's identity is approved.

Tunnel client: forward proxy clients managed by Sourcegraph, added to the customer's Sourcegraph Cloud instance. Every client has its own identity and it cannot establish a direct connection with the customer agent, and has to go through tunnel server.

<iframe
  src="https://link.excalidraw.com/readonly/453uvY8infI8wskSecGJ"
  width="100%"
  height="100%"
  style={{ border: "none" }}
/>
[Diagram link](https://link.excalidraw.com/readonly/453uvY8infI8wskSecGJ)

## Steps

### Initiate the process

The customer reaches out to their account manager to initiate the process. The account manager will work with the customer to collect the required information and initiate the process, including but not limited to:

- The DNS name of the private code host, e.g. `gitlab.internal.company.net` or private artifact registry, e.g. `artifactory.internal.company.net`
- The port of the private code host, e.g., `443`, `80`, `22`
- The type of TLS certificate used by the private resource: self-signed, internal PKI, or issued by a public CA

Sourcegraph will provide the instructions and credentials to run the agent, and public IPs and ports of the tunnel server to allowlist egress traffic.

### Create the connection

The customer follows the instructions, and installs the agent in their private network. At a high level:

- Permit internet egress to the provided endpoint static IPs and ports
- Permit egress to the private resources
- Run the tunnel agent (via Docker container, or binary) with the provided config file and credentials

### Configure the code host connection

Once the tunnel is established between the agent and server, the customer can configure the [code host connection](/admin/code_hosts/) on their Sourcegraph Cloud instance.

## FAQ

### Why TCP over gRPC?

The tunnel between the client and agent is built using TCP over gRPC. gRPC is a high-performant and battle-tested framework, e.g., built-in support for mTLS for a trusted secure connection. TCP and HTTP/2 are widely supported in the majority of customer environments. Moreover, the simplicity of having a single endpoint for connection between customer environment and their Cloud instance greatly simplifies the work required for customer IT admin. Compared to traditional VPN solutions, such as OpenVPN, IPSec, and SSH over bastion hosts, gRPC allows us to design our own protocol, and the programmable interface allows us to implement advanced features, e.g., fine-grained access control at a per-connection level, audit logging with rich metadata, etc.

### How are connections encrypted? Can anyone else inspect the traffic?

Connections between the tunnel agent inside customer network and a tunnel server inside customer dedicated Sourcegraph GCP VPC use mTLS. Agents, server, and clients all have their own certificates and encrypt / decrypt traffic over TCP. mTLS requires clients and agents to have a private key, and present a valid signed certificate from a trusted CA, which is not shared; this protects from [on-path and spoofing attacks](https://www.cloudflare.com/en-gb/learning/access-management/what-is-mutual-tls/).

### How do you authenticate requests?

Both tunnel clients and agents are assigned an identity corresponding to a GCP Service Account, and they are provided credentials to prove this identity. Agents use the Service Account key provided to the customer at install time, and clients use Workload Identity to prove their identity. They use these credentials to authenticate against the tunnel server by sending signed JWT tokens and public keys. JWT tokens contain details to specify the GCP Service Account credential public key required to validate signature and confirm the identity of the requestor. The server then signs the requestor's public key and responds with a signed certificate containing the GCP Service Account email as a Subject Alternative Name (SAN).

For an added layer of security, if the customer network's NAT / internet gateway uses public IPs in a stable CIDR range, we can provision firewall rules to restrict access to the tunnel server from the provided IP ranges.

### How do you enforce authorization to restrict which requests can reach private resources?

With mTLS, every entity in the network has its own identity. The tunnel server is configured with ACLs, using the client's identity as the source, and the agent's identity as the destination. Tunnel server ensures that only clients with proven identity can communicate with customer tunnel agents.

### How do you manage keys and certificates?

We utilize GCP Certificate Authority Service (CAS), a managed Public Key Infrastructure (PKI) service. It is responsible for the storage of root and intermediate CA signing keys, and the signing of client certificates. Access to GCP CAS is governed by GCP IAM, and only necessary individuals and services can access CAS, with audit trails in GCP Logging.

The TLS private keys in the agents and clients only exist in memory, and are never transmitted or shared. Only the public key is sent to the tunnel server, to issue a signed certificate, to establish the mTLS connection.

### How often do you rotate the encryption keys?

Encryption keys are short-lived, and both tunnel agents and clients refresh their certificates every 24h. The customer may also manually rotate the agent's certificate by restarting the agent.

### How do you audit access?

Tunnel server logs operations with sufficient metadata to identify the requester to GCP Logging with a default 30-day retention policy. We also monitor unauthorized access events to watch for potential attacks.

### What if an attacker gains access to the Sourcegraph Cloud instance?

If an attacker gains access to the Sourcegraph Cloud instance's containers, this would be a security breach, and trigger our Incident Response process. However, we have many controls in place to prevent this from happening where Cloud infrastructure access always requires approval, and the Security team is on-call for unexpected usage patterns. You may learn more from our [Security Portal](https://security.sourcegraph.com/).

Please reach out to us if you have any specific questions regarding our Cloud security posture, we are happy to provide more detail to address your concerns.

### How do I need to configure my network for the agent to work?

The tunnel agent needs to connect to the tunnel server. Sourcegraph will provide a dedicated static IP from a customer-dedicated GCP VPC which is used to connect with the tunnel server. The customer must configure network egress to allow TCP (HTTP/2) traffic access to this static IP.

### How can I restrict access to my private resources?

The customer has full control of their network where they deploy the tunnel agent, and can configure, monitor, and terminate the connection at will. We recommend implementing an allowlist to restrict the egress traffic of the agent to the IP addresses provided by Sourcegraph and to the specific private resources your Sourcegraph Cloud instance needs to access, and configuring your firewall to alert you if this ACL is hit. If your code hosts or registries use DNS names, the agent will need access to the DNS server configured on its host.

### How can I harden the tunnel agent deployment?

You can:

- Deploy the agent on a hardened container platform
- Store the agent credential and config content in a secrets management system and mount these secrets to the container
- Forward the agent's logs to your log management system

### How can I inspect the agent's traffic, and audit the data the agent is accessing in my environment?

If a customer needs to inspect and audit traffic, such as performing TLS inspection on the connection between the private resources and Sourcegraph Cloud, we recommend inspecting traffic between the tunnel agent and internal resources, as this traffic uses the protocols and encryption of the internal resources. The tunnel from the agent to the server is encrypted and authenticated by mTLS over gRPC, and uses a custom protocol, so the decrypted payload isn't useable for traffic inspection.

### Can I use Internal PKI or self-signed TLS certificates for my private resources?

Yes. Please work with your account team to add the public certificate chain of your internal CA under `experimentalFeatures.tls.external.certificates` in your instance's [site configuration](/admin/config/site_config#experimentalFeatures).

### Is this connection highly available?

To obtain high availability, customers can run multiple tunnel agents across their network. Each agent uses the same GCP Service Account credentials, authenticates with the tunnel server, and establishes their own connection to it. The tunnel client will randomly select an available agent to forward traffic through.
